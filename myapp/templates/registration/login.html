{% load static %}
<!DOCTYPE html>
<html dir="rtl" lang="ar">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <title>تسجيل الدخول</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.rtl.min.css' %}" />
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.5/jquery.validate.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;500;700;800&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: "Noto Kufi Arabic";
      }
      #id_background_container {
        background: url("{% static '/imgs/confetti_bg.svg' %}") no-repeat center center fixed;
        background-size: cover;
        height: 100vh;
      }
    </style>
  </head>
  <body id="id_background_container">
    <div class="row mx-auto justify-content-center">
      <div class="card mt-5 mb-4 p-5 my-4 bg-light rounded-3" style="width: 35rem;">
        <a href="{% url 'home' %}">
        <img class="img-fluid rounded-3 card-img-top" src="{% static '/imgs/logo-c-1.png' %}" alt="Logo">
        </a>
        <div class="card-body">
          <h2 class="card-title fw-bold mb-5 mt-4 text-center">تسجيل الدخول</h2>
          <div class="col">
            {% if messages %}
              {% for message in messages %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                  {{ message }}
                  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
              {% endfor %}
            {% endif %}
            
            <!-- Login Form -->
            <form method="post" id="sign-in-form" action="{% url 'login' %}">
              {% csrf_token %}
              <div class="col mb-3">
                <label for="id_username" class="form-label">اسم المستخدم / رقم الهاتف / رقم الهوية</label>
                <input type="text" name="username" class="form-control" id="id_username" placeholder="أدخل اسم المستخدم أو رقم الهاتف أو رقم الهوية" required>
              </div>
              <div class="col mb-3" id="password-field-container" style="display: none;">
                <label for="id_password" class="form-label">كلمة المرور</label>
                <input type="password" name="password" class="form-control" id="id_password" placeholder="أدخل كلمة المرور">
              </div>
              <button type="button" class="w-100 btn btn-lg btn-primary mt-3" id="sign_in_btn">تسجيل الدخول</button>
              <p class="mt-4 text-center">ليس لديك حساب؟ <a href="{% url 'sign-up' %}">تسجيل حساب جديد</a></p>
              <p class="mt-1 text-center">لم تصلك رسالة التفعيل؟ <a href="{% url 'resend_activation_email_view' %}">اضغط هنا</a></p>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- OTP Modal -->
    <div class="modal fade" id="otp-modal" tabindex="-1" aria-labelledby="otpModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">رمز التحقق</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="otp-form">
              {% csrf_token %}
              <input type="hidden" name="phone_number" id="otp-phone-number">
              <label for="otp-input" class="form-label">أدخل رمز التحقق المرسل:</label>
              <input type="text" id="otp-input" name="otp" class="form-control" required>
            </form>
          </div>
          <div class="modal-footer">
            <button type="submit" id="verify-otp-btn" class="btn btn-primary">تأكيد</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      $(document).ready(function () {
        const usernameField = $("#id_username");
        const passwordContainer = $("#password-field-container");
        const otpModal = new bootstrap.Modal($("#otp-modal"));

        // Dynamic field behavior
        usernameField.on("input", function () {
          const input = $(this).val();
          const phonePattern = /^(5|9665|\+9665)\d{8}$/;
          const nationalIdPattern = /^\d{10}$/;
          const usernamePattern = /^[a-zA-Z0-9_]{3,}$/;

          if (phonePattern.test(input)) {
            passwordContainer.hide();
          } else if (nationalIdPattern.test(input) || usernamePattern.test(input)) {
            passwordContainer.show();
          } else {
            passwordContainer.hide();
          }
        });

        // Handle login submission
        $("#sign_in_btn").click(function (e) {
          e.preventDefault();
          const input = usernameField.val();
          const phonePattern = /^(5|9665|\+9665)\d{8}$/;

          if (phonePattern.test(input)) {
            // Send OTP if phone number
            $.post("{% url 'login' %}", {
              username: input,
              csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
            })
            .done(function () {
              $("#otp-phone-number").val(input);
              otpModal.show();
            })
            .fail(function () {
              alert("فشل في إرسال رمز التحقق. حاول مرة أخرى.");
            });
          } else {
            // Submit form for username/national ID
            $("#sign-in-form").submit();
          }
        });

        // Verify OTP
        $("#verify-otp-btn").click(function () {
          const phoneNumber = $("#otp-phone-number").val();
          const otp = $("#otp-input").val();

          $.post("{% url 'verify_otp_login' %}", {
            phone_number: phoneNumber,
            otp: otp,
            csrfmiddlewaretoken: $("input[name=csrfmiddlewaretoken]").val(),
          })
          .done(function () {
            window.location.href = "{% url 'home' %}";
          })
          .fail(function () {
            alert("رمز التحقق غير صحيح.");
          });
        });
      });
    </script>
  </body>
</html>
