{% extends "dashboard/dbase.html" %} {% load humanize %} {% block title %} الصفحة الرئيسية {% endblock %}
{% block head %}
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
{% endblock %}
{% block content %}
<div class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
  <div class="col row-gap-3 justify-content-md-center">
      <div class="col-md-auto p-1 pt-3 mt-4 bg-dark rounded-3 d-flex flex-column justify-content-center align-self-center table-responsive text-nowrap" style="overflow-x: scroll">
        <p class="text-light ms-2 fs-3">طلبات المستفيدين</p>
        <table class="table table-success table-striped-columns mb-1">
          <thead class="">
            <tr>
              <th scope="col">#</th>
              {% for header in beneficiaries_headers %}
              <th scope="col">{{ header }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in beneficiary_obj %}
            <tr>
              <th scope="row">{{ row.id }}</th>
              <td class="col">{{ row.file_no }}</td>
              <td class="col">{{ row.first_name }}</td>
              <td class="col">{{ row.last_name }}</td>
              <td class="col">{{ row.category }}</td>
              <td class="col">{{ row.health_status }}</td>
              <td class="col">{{ row.receivedAt }}</td>
              <td class="col">{{ row.marital_status }}</td>
              {% if row.is_qualified == 0 %}
              <td class="col"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
              </svg></td>
              {% else %}
              <td class="col"><svg xmlns="http://www.w3.org/2000/svg" width="26" height="26" fill="currentColor" class="bi bi-check-circle-fill" viewBox="0 0 16 16">
                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zm-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
              </svg></td>
              {% endif %}
              {% comment %} <td>{{ row }}</td>  {% endcomment %}
              <td class="col"><!-- Button trigger modal -->
                <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#exampleModal2">
                  الغاء
                </button>

                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#exampleModal3">
                  قبول
                </button>

                <button type="button" class="btn btn-primary btn-details" data-bs-toggle="modal" data-bs-target="#exampleModal" data-id="{{ row.id }}">
                  تفاصيل الطلب
                </button>
                
                <!-- Modal -->
                <div class="modal fade" id="exampleModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered modal-xl modal-lg">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">تفاصيل الطلب</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <form>
                          {% csrf_token %}
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_file_no">رقم الملف</h6>
                            <input type="text" class="form-control" id="id_modal_file_no" name="file_no" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_first_name">الأسم الأول</h6>
                            <input type="text" class="form-control" id="id_modal_first_name" name="first_name" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_second_name">الأسم الثاني</h6>
                            <input type="text" class="form-control" id="id_modal_second_name" name="second_name" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_last_name">الأسم الأخير</h6>
                            <input type="text" class="form-control" id="id_modal_last_name" name="last_name" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_nationality">الجنسية</h6>
                            <input type="text" class="form-control" id="id_modal_nationality" name="nationality" disabled readonly>
                          </div>

                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_gender">الجنس</h6>
                            <input type="text" class="form-control" id="id_modal_gender" name="gender" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_date_of_birth">تاريخ الميلاد</h6>
                            <input type="text" class="form-control" id="id_modal_date_of_birth" name="date_of_birth" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_phone_number">رقم الجوال</h6>
                            <input type="text" class="form-control" id="id_modal_phone_number" name="phone_number" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_email">الايميل الالكتروني</h6>
                            <input type="email" class="form-control" id="id_modal_email" name="email" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_national_id">رقم الهوية/الإقامة</h6>
                            <input type="text" class="form-control" id="id_modal_national_id" name="national_id" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_national_id_exp_date">تاريخ انتهاء الهوية/الإقامة</h6>
                            <input type="text" class="form-control" id="id_modal_national_id_exp_date" name="national_id_exp_date" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_category">التصنيف الرئيسي</h6>
                            <input type="text" class="form-control" id="id_modal_category" name="category" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_marital_status">الحالة الاجتماعية</h6>
                            <input type="text" class="form-control" id="id_modal_marital_status" name="marital_status" disabled readonly>
                          </div>

                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_educational_level">المستوى التعليمي</h6>
                            <input type="text" class="form-control" id="id_modal_educational_level" name="educational_level" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_health_status">الحالة الصحية</h6>
                            <input type="text" class="form-control" id="id_modal_health_status" name="health_status" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_disease_type">نوع المرض</h6>
                            <input type="text" class="form-control" id="id_modal_disease_type" name="disease_type" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_work_status">هل يعمل؟</h6>
                            <input type="text" class="form-control" id="id_modal_work_status" name="work_status" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_employer">جهة العمل</h6>
                            <input type="text" class="form-control" id="id_modal_employer" name="employer" disabled readonly>
                          </div>

                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_death_date_father_husband">تاريخ وفاة الأب/الزوج</h6>
                            <input type="text" class="form-control" id="id_modal_death_date_father_husband" name="death_date_father_husband" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_washing_place">المغسلة التي تم التجهيز فيها</h6>
                            <input type="text" class="form-control" id="id_modal_washing_place" name="washing_place" disabled readonly>
                          </div>

                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_bank_type">أسم البنك</h6>
                            <input type="text" class="form-control" id="id_modal_bank_type" name="bank_type" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_bank_iban">رقم الإيبان</h6>
                            <input type="text" class="form-control" id="id_modal_bank_iban" name="bank_iban" disabled readonly>
                          </div>

                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_family_issues">المشاكل التي تعاني منها الأسرة</h6>
                            <input type="text" class="form-control" id="id_modal_family_issues" name="family_issues" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_family_needs">احتياجات الأسرة</h6>
                            <input type="text" class="form-control" id="id_modal_family_needs" name="family_needs" disabled readonly>
                          </div>

                          <hr>

                          {% comment %} dependents data displayed below {% endcomment %}
                          <div id="dependentsAccordion"></div>

                          <hr>

                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_received_at">تاريخ الاستلام</h6>
                            <input type="datetime" class="form-control" id="id_modal_received_at" name="received_at" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_reviewd_at">تاريخ المراجعة</h6>
                            <input type="text" class="form-control" id="id_modal_reviewd_at" name="reviewd_at" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_is_qualified">مؤهل؟</h6>
                            <input type="text" class="form-control" id="id_modal_is_qualified" name="is_qualified" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <h6 class="col form-label" for="id_modal_is_benefiting">مستفيد؟</h6>
                            <input type="text" class="form-control" id="id_modal_is_benefiting" name="is_benefiting" disabled readonly>
                          </div>
                          <div class="mb-3">
                            <label for="id_modal_needs_descriptions" class="col form-label">وصف الاحتياج</label>
                            <textarea class="form-control" id="id_modal_needs_descriptions"></textarea>
                          </div>
                        </form>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">الغاء</button>
                        <button type="button" class="btn btn-primary">قبول الطلب</button>
                      </div>
                    </div>
                  </div>
                </div>

                {% comment %} exampleModal 2 {% endcomment %}
                <div class="modal fade" id="exampleModal2" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">تأكيد</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <p class="fs-4 text-center">هل أنت متأكد؟</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">الغاء</button>
                        <button type="button" class="btn btn-danger">نعم, متأكد!</button>
                      </div>
                    </div>
                  </div>
                </div>

                {% comment %} exampleModal 3 {% endcomment %}
                <div class="modal fade" id="exampleModal3" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">تأكيد</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body">
                        <p class="fs-4 text-center">هل أنت متأكد؟</p>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">الغاء</button>
                        <button type="button" class="btn btn-success">نعم, متأكد!</button>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <nav class="mt-3" aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
          {% if beneficiary_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1">الاول</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ beneficiary_obj.previous_page_number }}">السابق</a>
          </li>
          {% endif %}

          <li class="page-item disabled"><a class="page-link" >الصفحة {{ beneficiary_obj.number }} من {{ beneficiary_obj.paginator.num_pages }}</a></li>

          {% if beneficiary_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ beneficiary_obj.next_page_number }}">التالي</a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ beneficiary_obj.paginator.num_pages }}">الأخير</a>
          </li>
          {% endif %}
        </ul>
      </nav>
  </div>
</div>
<script>
  // Add an event listener for the details button
  document.querySelectorAll('.btn-details').forEach(function(button) {
     button.addEventListener('click', function() {
        var beneficiaryId = this.getAttribute('data-id');

        // Fetch request using beneficiaryId to get the beneficiary details:
        fetch('http://127.0.0.1:8000/beneficiary_details/' + beneficiaryId)
           .then(response => response.json())
           .then(data => {
              console.log(data);
              // Update modal content based on the received data
              document.getElementById('id_modal_file_no').value = data.file_no;
              document.getElementById('id_modal_first_name').value = data.first_name;
              document.getElementById('id_modal_second_name').value = data.second_name;
              document.getElementById('id_modal_last_name').value = data.last_name;
              document.getElementById('id_modal_nationality').value = data.nationality;
              document.getElementById('id_modal_gender').value = data.gender;

              // Convert the date into more convinent format
              var date_of_birth = "";
              date_of_birth = data.date_of_birth.substring(0, 10);
              document.getElementById('id_modal_date_of_birth').value = date_of_birth;

              document.getElementById('id_modal_phone_number').value = data.phone_number;
              document.getElementById('id_modal_email').value = data.email;
              document.getElementById('id_modal_national_id').value = data.national_id;

              // Convert the date into more convinent format
              var national_id_exp_date = "";
              if (data.national_id_exp_date != null) {
                national_id_exp_date = data.national_id_exp_date.substring(0, 10);
              }
              document.getElementById('id_modal_national_id_exp_date').value = national_id_exp_date;

              document.getElementById('id_modal_is_qualified').value = data.is_qualified;
              document.getElementById('id_modal_category').value = data.category;
              document.getElementById('id_modal_marital_status').value = data.marital_status;
              document.getElementById('id_modal_educational_level').value = data.educational_level;
              document.getElementById('id_modal_health_status').value = data.health_status;
              document.getElementById('id_modal_disease_type').value = data.disease_type;
              document.getElementById('id_modal_work_status').value = data.work_status;
              document.getElementById('id_modal_employer').value = data.employer;

              // Convert the date into more convinent format
              var death_date_father_husband = "";
              if (data.death_date_father_husband != null) {
                death_date_father_husband = data.death_date_father_husband.substring(0, 10);
              }
              document.getElementById('id_modal_death_date_father_husband').value = death_date_father_husband;

              document.getElementById('id_modal_washing_place').value = data.washing_place;
              document.getElementById('id_modal_is_benefiting').value = data.is_benefiting;

              // Convert ISO 8601 date into Date objects
              var receive_date = new Date(data.received_at);
              var review_date = new Date(data.reviewed_at);
              document.getElementById('id_modal_received_at').value = receive_date;
              document.getElementById('id_modal_reviewd_at').value = review_date;

              document.getElementById('id_modal_bank_type').value = data.bank_type;
              document.getElementById('id_modal_bank_iban').value = data.bank_iban;
              document.getElementById('id_modal_family_issues').value = data.family_issues;
              document.getElementById('id_modal_family_needs').value = data.family_needs;

              // Dependents Accordion data
              const dependentsAccordion = document.getElementById('dependentsAccordion');

              // Check if there are dependents
              if (data.dependent_list && data.dependent_list.length > 0) {
                  const accordionHtml = `
                    <h4>المرافقين</h4>
                    <div class="accordion mt-3" id="dependentsAccordion">
                      ${data.dependent_list.map((dependent, index) => `
                        <div class="accordion-item">
                          <h2 class="accordion-header" id="dependentHeading${index}">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dependentCollapse${index}" aria-expanded="false" aria-controls="dependentCollapse${index}">
                              ${dependent.dependent_first_name} ${dependent.dependent_second_name} ${dependent.dependent_last_name}
                            </button>
                          </h2>
                          <div id="dependentCollapse${index}" class="accordion-collapse collapse" aria-labelledby="dependentHeading${index}">
                            <div class="accordion-body">
                              <strong>معلومات المرافق:</strong>
                              <!-- Add dependent details here -->
                              <p>رقم المرافق: ${dependent.dependent_id}</p>
                              <!-- Add other dependent fields as needed -->
                            </div>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  `;

                  // Append the accordion HTML to the dependentsAccordion container
                  dependentsAccordion.innerHTML = accordionHtml;

              } else {
                  // Display a message or handle the case when there are no dependents
                  dependentsAccordion.innerHTML = '<h4>المرافقين</h4><p>لا يوجد مرافقين</p>';
              }
           })
           .catch(error => {
              console.error('Error:', error);
           });
     });
  });

  
</script>



{% endblock %}